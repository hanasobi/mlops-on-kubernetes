name: Build Deployment Deployment Image

on:
  push:
    branches:
      - main
      - develop
    tags:
      - 'v*'
    paths:
      - 'deployment/triton/**'
      - 'docker/triton/Dockerfile.deployment'
      - '.github/workflows/triton-build-deployment-image.yaml'
  
  workflow_dispatch:
    inputs:
      tag:
        description: 'Custom image tag (optional)'
        required: false

permissions:
  id-token: write
  contents: read  

jobs:
  build-deployment-image:
    runs-on: ubuntu-latest

    env:
      AWS_REGION: eu-central-1
      ACCOUNT_ID: 123456789012
      IMAGE_NAME: mlops-deployment-tools

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set image tag
        id: set-tag
        run: |
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            TAG=${GITHUB_REF#refs/tags/}
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ github.event.inputs.tag }}" ]]; then
            TAG="${{ github.event.inputs.tag }}"
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            TAG="latest"
          else
            BRANCH=${GITHUB_REF#refs/heads/}
            SHORT_SHA=${GITHUB_SHA:0:7}
            TAG="${BRANCH}-${SHORT_SHA}"
          fi
          
          echo "IMAGE_TAG=${TAG}" >> $GITHUB_ENV
          echo "Building with tag: ${TAG}"

      - name: Request OIDC Token
        id: idtoken
        uses: actions/github-script@v6
        with:
          script: |
            const token = await core.getIDToken();
            core.setOutput("token", token);
            
      - name: Decode OIDC Token
        run: |
          echo "${{ steps.idtoken.outputs.token }}" \
          | cut -d '.' -f2 \
          | base64 --decode \
          | jq .
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2
      
      - name: Build deployment image
        run: |
          echo "Building image with tag: ${IMAGE_TAG}"
          docker build -f docker/triton/Dockerfile.deployment \
            -t ${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${IMAGE_NAME}:${IMAGE_TAG} \
            .

      - name: Test image dependencies
        run: |
          echo "Testing that all Python dependencies are importable..."
          docker run --rm ${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${IMAGE_NAME}:${IMAGE_TAG} \
            python -c "
          import mlflow
          import boto3
          import onnx
          import onnxruntime
          import numpy
          import requests
          print('✓ All dependencies imported successfully')
          print(f'MLflow: {mlflow.__version__}')
          print(f'ONNX Runtime: {onnxruntime.__version__}')
          print(f'NumPy: {numpy.__version__}')
          "
      
      - name: Push deployment image
        run: |
          echo "Pushing image to ECR..."
          docker push ${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${IMAGE_NAME}:${IMAGE_TAG}

      - name: Check image size
        run: |
          IMAGE_SIZE=$(docker images ${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${IMAGE_NAME}:${IMAGE_TAG} --format "{{.Size}}")
          echo "Image size: ${IMAGE_SIZE}"
          
          SIZE_BYTES=$(docker image inspect ${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${IMAGE_NAME}:${IMAGE_TAG} --format='{{.Size}}')
          SIZE_MB=$((SIZE_BYTES / 1024 / 1024))
          
          echo "Image size in MB: ${SIZE_MB}"
          
          if [ ${SIZE_MB} -gt 1024 ]; then
            echo "⚠️ Warning: Image size exceeds 1GB"
          fi
      
      - name: Output image URI
        run: |
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo "Deployment image built and pushed successfully!"
          echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
          echo ""
          echo "Image URI:"
          echo "${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${IMAGE_NAME}:${IMAGE_TAG}"
          echo ""
          echo "To use in Argo Workflows, update the image field to:"
          echo "  image: ${ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${IMAGE_NAME}:${IMAGE_TAG}"
          echo ""
